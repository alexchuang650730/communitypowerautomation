name: PowerAutomation CI/CD Quality Check

on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches: [ main, master ]
  
  # Pull Requestæ™‚è§¸ç™¼
  pull_request:
    branches: [ main, master ]
  
  # å®šæ™‚è§¸ç™¼ - æ¯å¤©å‡Œæ™¨2é»åŸ·è¡Œå®Œæ•´æª¢æŸ¥
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æ¸¬è©¦é¡å‹'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick
        - full
      
      force_run:
        description: 'å¼·åˆ¶é‹è¡Œï¼ˆå¿½ç•¥ç·©å­˜ï¼‰'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  PROJECT_ROOT: '/home/runner/work/communitypowerautomation/communitypowerautomation'

jobs:
  # åå±¤ç´šæ¸¬è©¦ä½œæ¥­
  ten-layer-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'quick')
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        # å®‰è£æ¸¬è©¦æ‰€éœ€çš„é¡å¤–ä¾è³´
        pip install pytest pytest-cov bandit safety
    
    - name: è¨­ç½®é …ç›®ç’°å¢ƒ
      run: |
        # å‰µå»ºå¿…è¦çš„ç›®éŒ„
        mkdir -p ci_cd/{results,reports,logs,alerts,notifications}
        mkdir -p test/results
        
        # è¨­ç½®åŸ·è¡Œæ¬Šé™
        chmod +x ci_cd/run_checks.sh
        chmod +x test/ten_layer_test_executor.py
        
        # æª¢æŸ¥é…ç½®æ–‡ä»¶
        if [ ! -f ci_cd/config.json ]; then
          echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜èªé…ç½®"
          cp ci_cd/config.json.example ci_cd/config.json 2>/dev/null || true
        fi
    
    - name: é‹è¡Œåå±¤ç´šæ¸¬è©¦ç³»çµ±
      id: ten_layer_tests
      run: |
        echo "ğŸš€ é–‹å§‹åå±¤ç´šæ¸¬è©¦ç³»çµ±åŸ·è¡Œ..."
        
        # é‹è¡Œé—œéµå±¤ç´šæ¸¬è©¦ï¼ˆé©åˆCI/CDç’°å¢ƒï¼‰
        if python test/ten_layer_test_executor.py --mode critical --output test/results/ci_ten_layer_results.json; then
          echo "ten_layer_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… åå±¤ç´šæ¸¬è©¦é€šé"
        else
          echo "ten_layer_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ åå±¤ç´šæ¸¬è©¦å¤±æ•—"
          exit 1
        fi
        
        # é¡¯ç¤ºæ¸¬è©¦çµæœæ‘˜è¦
        if [ -f test/results/ci_ten_layer_results.json ]; then
          echo "ğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦:"
          python -c "
import json
with open('test/results/ci_ten_layer_results.json', 'r') as f:
    results = json.load(f)
    summary = results.get('summary', {})
    print(f'ç¸½å±¤ç´šæ•¸: {summary.get(\"total_layers\", 0)}')
    print(f'é€šéå±¤ç´š: {summary.get(\"passed_layers\", 0)}')
    print(f'å¤±æ•—å±¤ç´š: {summary.get(\"failed_layers\", 0)}')
    print(f'é—œéµå¤±æ•—: {summary.get(\"critical_failures\", 0)}')
    print(f'åŸ·è¡Œæ™‚é–“: {summary.get(\"total_execution_time\", 0):.2f}ç§’')
          "
        fi
    
    - name: é‹è¡Œå¿«é€Ÿè³ªé‡æª¢æŸ¥
      id: quick_check
      run: |
        echo "é–‹å§‹å¿«é€Ÿè³ªé‡æª¢æŸ¥..."
        
        # é‹è¡Œå¿«é€Ÿæª¢æŸ¥
        ./ci_cd/run_checks.sh quick
        
        # æå–çµæœ
        if [ -f ci_cd/logs/quick_check.log ]; then
          echo "æª¢æŸ¥æ—¥èªŒ:"
          cat ci_cd/logs/quick_check.log
        fi
        
        # æª¢æŸ¥æ˜¯å¦é€šé
        if grep -q "è³ªé‡æª¢æŸ¥çµæœ: âœ… é€šé" ci_cd/logs/quick_check.log; then
          echo "quick_check_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… å¿«é€Ÿæª¢æŸ¥é€šé"
        else
          echo "quick_check_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ å¿«é€Ÿæª¢æŸ¥å¤±æ•—"
          exit 1
        fi
    
    - name: ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ten-layer-and-quality-check-results
        path: |
          ci_cd/results/
          ci_cd/reports/
          ci_cd/logs/
          test/results/
        retention-days: 30
    
    - name: è©•è«–PRçµæœ
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          
          // è®€å–åå±¤ç´šæ¸¬è©¦çµæœ
          let tenLayerResults = null;
          if (fs.existsSync('test/results/ci_ten_layer_results.json')) {
            tenLayerResults = JSON.parse(fs.readFileSync('test/results/ci_ten_layer_results.json', 'utf8'));
          }
          
          // è®€å–è³ªé‡æª¢æŸ¥çµæœ
          let qualityCheckPassed = false;
          if (fs.existsSync('ci_cd/logs/quick_check.log')) {
            const logContent = fs.readFileSync('ci_cd/logs/quick_check.log', 'utf8');
            qualityCheckPassed = logContent.includes('è³ªé‡æª¢æŸ¥çµæœ: âœ… é€šé');
          }
          
          // æ§‹å»ºè©•è«–å…§å®¹
          let comment = `## ğŸ§ª PowerAutomation è‡ªå‹•åŒ–æ¸¬è©¦çµæœ
          
**æª¢æŸ¥æ™‚é–“**: ${new Date().toISOString()}
**è§¸ç™¼äº‹ä»¶**: Pull Request

### ğŸ—ï¸ åå±¤ç´šæ¸¬è©¦ç³»çµ±
`;
          
          if (tenLayerResults) {
            const summary = tenLayerResults.summary || {};
            const tenLayerPassed = summary.critical_failures === 0;
            
            comment += `**ç‹€æ…‹**: ${tenLayerPassed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
**ç¸½å±¤ç´šæ•¸**: ${summary.total_layers || 0}
**é€šéå±¤ç´š**: ${summary.passed_layers || 0}
**å¤±æ•—å±¤ç´š**: ${summary.failed_layers || 0}
**é—œéµå¤±æ•—**: ${summary.critical_failures || 0}
**åŸ·è¡Œæ™‚é–“**: ${(summary.total_execution_time || 0).toFixed(2)}ç§’

`;
            
            // æ·»åŠ è©³ç´°å±¤ç´šçµæœ
            if (tenLayerResults.layers) {
              comment += `#### è©³ç´°å±¤ç´šçµæœ:
`;
              for (const [layerId, layerResult] of Object.entries(tenLayerResults.layers)) {
                const status = layerResult.overall_success ? 'âœ…' : 'âŒ';
                comment += `- ${status} ç¬¬${layerId}å±¤ç´š: ${layerResult.name} (${(layerResult.execution_time || 0).toFixed(2)}s)
`;
              }
            }
          } else {
            comment += `**ç‹€æ…‹**: âŒ æ¸¬è©¦çµæœæ–‡ä»¶ä¸å­˜åœ¨
`;
          }
          
          comment += `
### ğŸ” GAIAè³ªé‡æª¢æŸ¥
**ç‹€æ…‹**: ${qualityCheckPassed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}

### ğŸ“‹ ç¸½çµ
`;
          
          const overallPassed = tenLayerResults && tenLayerResults.summary.critical_failures === 0 && qualityCheckPassed;
          
          if (overallPassed) {
            comment += `âœ… **æ‰€æœ‰æ¸¬è©¦é€šéï¼Œä»£ç¢¼å¯ä»¥å®‰å…¨åˆä½µ**

- åå±¤ç´šæ¸¬è©¦ç³»çµ±é‹è¡Œæ­£å¸¸
- GAIAè³ªé‡æª¢æŸ¥é”æ¨™
- ç³»çµ±æº–å‚™å¥½éƒ¨ç½²`;
          } else {
            comment += `âŒ **æ¸¬è©¦æœªå®Œå…¨é€šéï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®å¾©å•é¡Œ**

è«‹æŸ¥çœ‹è©³ç´°æ—¥èªŒä¸¦ä¿®å¾©å¤±æ•—çš„æ¸¬è©¦é …ç›®ã€‚`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # å®Œæ•´æª¢æŸ¥ä½œæ¥­
  full-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'full')
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest pytest-cov
    
    - name: è¨­ç½®é …ç›®ç’°å¢ƒ
      run: |
        mkdir -p ci_cd/{results,reports,logs,alerts,notifications}
        chmod +x ci_cd/run_checks.sh
    
    - name: é‹è¡Œå®Œæ•´è³ªé‡æª¢æŸ¥
      id: full_check
      run: |
        echo "é–‹å§‹å®Œæ•´è³ªé‡æª¢æŸ¥..."
        
        # è¨­ç½®è¶…æ™‚ï¼ˆ30åˆ†é˜ï¼‰
        timeout 1800 ./ci_cd/run_checks.sh full || {
          echo "å®Œæ•´æª¢æŸ¥è¶…æ™‚æˆ–å¤±æ•—"
          exit 1
        }
        
        # æª¢æŸ¥çµæœ
        if grep -q "è³ªé‡æª¢æŸ¥çµæœ: âœ… é€šé" ci_cd/logs/full_check.log; then
          echo "full_check_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… å®Œæ•´æª¢æŸ¥é€šé"
        else
          echo "full_check_passed=false" >> $GITHUB_OUTPUT
          echo "âŒ å®Œæ•´æª¢æŸ¥å¤±æ•—"
          exit 1
        fi
    
    - name: ç”Ÿæˆè¶¨å‹¢åˆ†æ
      run: |
        echo "ç”Ÿæˆè¶¨å‹¢åˆ†æ..."
        ./ci_cd/run_checks.sh trend 7
    
    - name: ä¸Šå‚³å®Œæ•´æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: full-check-results
        path: |
          ci_cd/results/
          ci_cd/reports/
          ci_cd/logs/
        retention-days: 90
    
    - name: ç™¼é€Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#powerautomation-ci'
        text: |
          PowerAutomation å®Œæ•´è³ªé‡æª¢æŸ¥å®Œæˆ
          ç‹€æ…‹: ${{ steps.full_check.outputs.full_check_passed == 'true' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }}
          åˆ†æ”¯: ${{ github.ref }}
          æäº¤: ${{ github.sha }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # å¥åº·æª¢æŸ¥ä½œæ¥­
  health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: é‹è¡Œå¥åº·æª¢æŸ¥
      run: |
        chmod +x ci_cd/run_checks.sh
        ./ci_cd/run_checks.sh health
    
    - name: æ¸…ç†èˆŠæ–‡ä»¶
      run: |
        ./ci_cd/run_checks.sh cleanup

  # éƒ¨ç½²æª¢æŸ¥ä½œæ¥­ï¼ˆåƒ…åœ¨ä¸»åˆ†æ”¯ï¼‰
  deploy-check:
    runs-on: ubuntu-latest
    needs: [ten-layer-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: æª¢æŸ¥éƒ¨ç½²å°±ç·’ç‹€æ…‹
      run: |
        echo "æª¢æŸ¥ç³»çµ±æ˜¯å¦æº–å‚™å¥½éƒ¨ç½²..."
        
        # æª¢æŸ¥æœ€æ–°çš„æ¸¬è©¦çµæœ
        if [ -f ci_cd/results/quick_check_*.json ]; then
          latest_result=$(ls -t ci_cd/results/quick_check_*.json | head -1)
          
          # æª¢æŸ¥æ˜¯å¦é”åˆ°éƒ¨ç½²æ¨™æº–
          if grep -q '"passed": true' "$latest_result"; then
            echo "âœ… ç³»çµ±æº–å‚™å¥½éƒ¨ç½²"
            echo "deploy_ready=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç³»çµ±æœªæº–å‚™å¥½éƒ¨ç½²"
            echo "deploy_ready=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦çµæœ"
          echo "deploy_ready=false" >> $GITHUB_OUTPUT
        fi
    
    - name: å‰µå»ºéƒ¨ç½²æ¨™ç±¤
      if: steps.deploy-check.outputs.deploy_ready == 'true'
      run: |
        # å‰µå»ºéƒ¨ç½²æ¨™ç±¤
        timestamp=$(date +%Y%m%d-%H%M%S)
        tag_name="deploy-${timestamp}"
        
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "$tag_name" -m "è‡ªå‹•éƒ¨ç½²æ¨™ç±¤ - è³ªé‡æª¢æŸ¥é€šé"
        git push origin "$tag_name"
        
        echo "âœ… å‰µå»ºéƒ¨ç½²æ¨™ç±¤: $tag_name"

  # æ€§èƒ½ç›£æ§ä½œæ¥­
  performance-monitor:
    runs-on: ubuntu-latest
    needs: [ten-layer-tests]
    if: always()
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: åˆ†ææ€§èƒ½è¶¨å‹¢
      run: |
        echo "åˆ†ææ€§èƒ½è¶¨å‹¢..."
        
        # é€™è£¡å¯ä»¥æ·»åŠ æ€§èƒ½åˆ†æé‚è¼¯
        # ä¾‹å¦‚ï¼šæ¯”è¼ƒåŸ·è¡Œæ™‚é–“ã€æˆåŠŸç‡è®ŠåŒ–ç­‰
        
        if [ -f ci_cd/logs/quick_check.log ]; then
          echo "æœ€æ–°æª¢æŸ¥çµæœ:"
          grep "æˆåŠŸç‡\|åŸ·è¡Œæ™‚é–“" ci_cd/logs/quick_check.log || true
        fi
    
    - name: æ›´æ–°æ€§èƒ½å„€è¡¨æ¿
      run: |
        echo "æ›´æ–°æ€§èƒ½å„€è¡¨æ¿..."
        # é€™è£¡å¯ä»¥é›†æˆåˆ°ç›£æ§ç³»çµ±
        # ä¾‹å¦‚ï¼šGrafanaã€Datadogç­‰

